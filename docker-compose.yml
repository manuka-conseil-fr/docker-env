version: '3'

networks:
#  public:
#    name: vpn_config
  private:
    name: lan_docker1
    ipam:
     config:
     - subnet: "10.10.10.0/24"

volumes:
  db-data:
  www:
  config:

configs:
  php_config:
    file: ./php.ini
  bdd_config:
    file: ./mariadb.conf
  vpn_config:
    file: ./vpn.conf
  
  postgres:
    image: kartoza/postgis:14
    ports:
      - ${POSTGRES_PUBLIC_PORT:-5435}:5432
    environment:
      - POSTGRES_DB=${DB_DATABASE:-postgres}
      - POSTGRES_USER=${DB_USERNAME:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-secret}
    volumes:
      - bd66-postgresql:/var/lib/postgresql/
    healthcheck:
      test: "PGPASSWORD=${DB_PASSWORD} pg_isready -h 127.0.0.1 -U ${DB_USERNAME} -d ${DB_DATABASE}"
      retries: 3
      timeout: 5s

  php:
    container_name: toto-php
    image: php:8.2-apache
    depends_on:
      - postgres
  
  wireguard:
    container_name: wireguard
    image: lscr.io/linuxserver/wireguard:latest
    cap_add:
    - NET_ADMIN
    networks:
      - lan_docker1
      - public
    environment:
    - PUID=$PUID
    - PGID=$PGID
    - TZ=$TZ
    - PEERS=Profile1,Profile2,OtherProfile
    volumes:
    - ./config:/config
    ports:
    ## port du serveur Wireguard
    - 51820:51820/udp
    ## port de l'interface de wireguard
    - 5000:5000
    restart: unless-stopped
  
  wireguard-ui:
    image: ngoduykhanh/wireguard-ui:latest
    container_name: Wireguard-ui
    depends_on:
      - wireguard
    cap_add:
      - "NET_ADMIN"
    network_mode: service:wireguard
    environment:
      - SENDGRID_API_KEY
      - EMAIL_FROM_ADDRESS
      - EMAIL_FROM_NAME
      - SESSION_SECRET
      - WGUI_USERNAME=admin
      - WGUI_PASSWORD=password
      - WG_CONF_TEMPLATE
      - WGUI_MANAGE_START=true
      - WGUI_MANAGE_RESTART=true
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: 50m
    volumes:
      - ./db:/app/db
      - ./config:/etc/wireguard
